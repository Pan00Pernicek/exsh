#!/usr/bin/env execlineb
multisubstitute { define version 0.0.4 importas 1 1 importas varstest vars define -s exsh "exsh" }
ifelse { test -z $1 } {
	ifthenelse { test -z $varstest  } { export vars "importas 0 0" exec $exsh } { true } 
	importas home HOME
	backtick -E PS1 { ifthenelse { test -f ${home}/.exshrc } { ${home}/.exshrc } { printf "\033[38;2;0;255;127mâ†’ \033[0;0m" } }
	foreground { echo -n $PS1 }
	backtick -E functions { ifthenelse { test -f ${home}/.exshrc } { ${home}/.exshrc functions } { true } }
	forstdin -x 1 exsh_cmd

	importas exsh_cmd exsh_cmd
	ifelse { test -z $exsh_cmd } { foreground { echo -n $PS1 } exit }
	foreground {
		importas -s exsh_split exsh_cmd
		backtick -E if { pipeline { echo $exsh_cmd } cut -d " " -f1 }
		backtick -E fn { foreground { pipeline { echo $functions } grep -w ${if} } true }
		ifelse { test $if = var } {
			backtick -E cmd { pipeline { echo $exsh_cmd } cut -d " " -f2 }
			backtick -E var { pipeline { echo $exsh_cmd } cut -d " " -f3 }
			backtick comm { pipeline { echo $exsh_cmd } cut --complement -d " " -f1,2,3 }
			multisubstitute { importas -s command comm importas comm comm }
			ifelse { test $cmd = -s } { 
				importas vars vars
				export vars "${vars} importas ${var} ${var}"
				export $var "${comm}" foreground { exec $exsh } }
			ifelse { test $cmd = -x } { 
				backtick -E wat { $command }
				importas vars vars
				export vars "${vars} importas ${var} ${var}"
				export $var "${wat}" foreground { exec $exsh } }
			ifelse { test $cmd = -u } {
				importas vars vars
				backtick vars { pipeline { echo "${vars}" } sed "s/ importas ${var} ${var}//g" }
				unexport $var exec $exsh }
			ifelse { test $cmd = -i } {
				importas vars vars
				export vars "${vars} importas ${var} ${var}" exec $exsh }
			ifelse { test $cmd = -e } {
				export $var "${comm}" exec $exsh }
			ifelse { test $cmd = -ue } {
				unexport $var exec $exsh }
			foreground { echo var: usage: var [ -s | -x | -u | -i | -e | -ue ] key value... } }
		ifelse { test $if = $fn } {
			ifthenelse { test -f ${home}/.exshrc } { ${home}/.exshrc fn $exsh_split } { true } }
		ifelse { test $if = cd } {
			backtick -E path { pipeline { echo $exsh_cmd } cut -d " " -f2 }
			cd $path exec $exsh }
		importas -s vars vars
		multisubstitute { $vars } execlineb -c $exsh_cmd }
	foreground { echo -n $PS1 } }
ifelse { test $1 = -v } { echo $version }
ifelse { test $1 = --version } { echo $version }
ifelse { test $1 = -i } { rlwrap -c exsh }
echo "exsh: usage: exsh [ -i | -v |   ]"
